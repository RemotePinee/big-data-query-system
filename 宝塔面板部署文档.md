# 大数据查询系统 - 宝塔面板部署文档

## 📋 部署概述

本文档详细介绍如何在宝塔面板上部署大数据查询系统，包括前端Vue应用和后端Node.js API服务。

## 🛠️ 环境要求

### 服务器配置
- **操作系统**: CentOS 7+ / Ubuntu 18+ / Debian 9+
- **内存**: 最低2GB，推荐4GB+
- **硬盘**: 最低20GB可用空间
- **网络**: 公网IP，开放80、443、3000端口

### 软件环境
- **宝塔面板**: 7.7.0+
- **Node.js**: 16.x+
- **MySQL**: 5.7+ / 8.0+
- **Nginx**: 1.18+
- **PM2**: 进程管理器

## 🚀 部署步骤

### 第一步：安装宝塔面板

```bash
# CentOS安装命令
yum install -y wget && wget -O install.sh http://download.bt.cn/install/install_6.0.sh && sh install.sh

# Ubuntu/Debian安装命令
wget -O install.sh http://download.bt.cn/install/install-ubuntu_6.0.sh && sudo bash install.sh
```

### 第二步：安装必要软件

在宝塔面板中安装以下软件：

1. **Nginx** (1.18+)
2. **MySQL** (5.7+ 或 8.0+)
3. **Redis** (6.0+)
4. **Node.js版本管理器**
5. **PM2管理器**

#### 2.1 Redis配置（新版宝塔面板）

新版宝塔面板的Redis配置方式：

1. **安装Redis**：在软件商店搜索并安装Redis
2. **Redis密码设置**：
   - 进入 **数据库** 菜单
   - 找到Redis管理界面
   - 点击 **设置** 或 **配置** 按钮
   - 设置Redis密码（建议设置强密码）
3. **Redis数据库操作**：
   - 在数据库菜单的Redis管理中
   - **添加key** 功能用于手动添加缓存数据
   - **数据库选择**：db0, db1, db2等是Redis的不同数据库编号
   - **键名**：缓存数据的key
   - **值**：对应的value
   - 一般情况下，应用会自动管理Redis数据，无需手动添加

**注意**：如果设置了Redis密码，需要在环境配置中填写 `REDIS_PASSWORD`

### 第三步：上传项目文件

1. 将 `production-package` 文件夹上传到服务器 `/www/wwwroot/` 目录
2. 重命名为项目名称，如 `/www/wwwroot/dashuju/`

### 第四步：数据库配置

#### 4.1 创建数据库

在宝塔面板 → 数据库 → 添加数据库：
- **数据库名**: `dashuju`
- **用户名**: `dashuju_user`
- **密码**: 生成强密码并记录

#### 4.2 导入数据库结构

```bash
# 进入项目目录
cd /www/wwwroot/dashuju/backend

# 导入数据库
mysql -u dashuju_user -p dashuju < sql/production-init-db.sql
```

### 第五步：后端部署

#### 5.1 配置环境变量

```bash
# 进入后端目录
cd /www/wwwroot/dashuju/backend

# 复制环境配置文件
cp .env.example .env

# 编辑环境配置
vim .env
```

配置内容：
```env
# 服务器配置
PORT=3000
NODE_ENV=production

# 数据库配置
DB_HOST=localhost
DB_USER=dashuju
DB_PASSWORD=你的数据库密码
DB_NAME=dashuju

# JWT配置
JWT_SECRET=b9b8aba82b657b869edce20967abafd59168ba58a5b3dd0a9ad9dcbedb4bec65a1bf554ba6e47c0558f7673cbdf1a75bfba6c0557179bf5fd315d57932f3a7ad
JWT_EXPIRES_IN=7d

# Redis配置
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=你在宝塔面板设置的Redis密码

# 支付配置（可选，建议在后台管理界面配置）
# 如果不在此配置，系统将使用后台配置的支付参数
# 微信支付
WECHAT_APP_ID=
WECHAT_APP_SECRET=
WECHAT_MERCHANT_ID=
WECHAT_API_KEY=
WECHAT_NOTIFY_URL=https://your-domain.com/api/payments/notify/wechat

# 支付宝
ALIPAY_APP_ID=
ALIPAY_PRIVATE_KEY=
ALIPAY_PUBLIC_KEY=
ALIPAY_NOTIFY_URL=https://your-domain.com/api/payments/notify/alipay
ALIPAY_RETURN_URL=https://your-domain.com/payment/result

# 易支付
EPAY_API_URL=
EPAY_MERCHANT_ID=
EPAY_API_KEY=
EPAY_NOTIFY_URL=https://your-domain.com/api/payments/notify/epay
EPAY_RETURN_URL=https://your-domain.com/payment/result

# 文件上传路径
UPLOAD_PATH=/www/wwwroot/dashuju/backend/uploads

# API基础URL
API_BASE_URL=https://你的域名.com/api
```

**重要配置说明：**
- `NODE_ENV=production`：必须设置为生产环境
- `DB_PASSWORD`：设置强密码保护数据库安全
- `REDIS_PASSWORD`：填写在宝塔面板Redis设置中配置的密码
- `JWT_SECRET`：已生成安全的随机密钥，请勿修改
- 所有回调URL必须使用HTTPS协议
- 将`your-domain.com`替换为实际域名

**关于支付配置：**
- **推荐方式**：环境变量中的支付参数可以留空，完全在后台管理界面配置
- 环境变量中只需要配置回调URL（NOTIFY_URL和RETURN_URL），确保支付回调正常
- 支付密钥、商户ID等敏感信息建议在后台配置，更安全且便于管理
- 系统会优先使用后台配置的支付参数，环境变量作为备用配置
- 如果某种支付方式不使用，相关配置项可以完全留空

#### 5.2 安装依赖

```bash
# 安装Node.js依赖
npm install --production

# 编译TypeScript
npm run build
```

#### 5.3 配置PM2

创建PM2配置文件 `ecosystem.config.js`：

```javascript
module.exports = {
  apps: [{
    name: 'dashuju-api',
    script: 'dist/index.js',
    cwd: '/www/wwwroot/dashuju/backend',
    instances: 1,
    exec_mode: 'fork',
    env: {
      NODE_ENV: 'production',
      PORT: 3000
    },
    log_file: '/www/wwwroot/dashuju/backend/logs/combined.log',
    out_file: '/www/wwwroot/dashuju/backend/logs/out.log',
    error_file: '/www/wwwroot/dashuju/backend/logs/error.log',
    log_date_format: 'YYYY-MM-DD HH:mm:ss',
    merge_logs: true,
    max_memory_restart: '1G'
  }]
};
```

#### 5.4 启动后端服务

```bash
# 创建日志目录
mkdir -p logs

# 启动服务
pm2 start ecosystem.config.js

# 设置开机自启
pm2 startup
pm2 save
```

### 第六步：前端部署

#### 6.1 配置环境变量

编辑 `frontend/.env.production`：

```env
# 生产环境配置
VITE_API_BASE_URL=https://你的域名.com/api
VITE_APP_TITLE=大数据查询系统
VITE_APP_ENV=production
```

#### 6.2 构建前端

```bash
# 进入前端目录
cd /www/wwwroot/dashuju/frontend

# 安装依赖
npm install

# 构建生产版本
npm run build
```

### 第七步：Nginx配置

#### 7.1 创建站点

在宝塔面板 → 网站 → 添加站点：
- **域名**: 你的域名
- **根目录**: `/www/wwwroot/dashuju/frontend/dist`
- **PHP版本**: 纯静态

#### 7.2 配置Nginx

编辑站点配置文件：

```nginx
server {
    listen 80;
    listen 443 ssl http2;
    server_name 你的域名.com;
    index index.html;
    root /www/wwwroot/dashuju/frontend/dist;
    
    # SSL配置（如果有证书）
    ssl_certificate /path/to/your/cert.pem;
    ssl_certificate_key /path/to/your/key.pem;
    
    # 前端路由配置
    location / {
        try_files $uri $uri/ /index.html;
    }
    
    # API代理配置
    location /api {
        proxy_pass http://127.0.0.1:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 处理跨域
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods 'GET, POST, PUT, DELETE, OPTIONS';
        add_header Access-Control-Allow-Headers 'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization';
        
        if ($request_method = 'OPTIONS') {
            return 204;
        }
    }
    
    # 文件上传配置
    location /uploads {
        alias /www/wwwroot/dashuju/backend/uploads;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }
    
    # 静态资源缓存
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    # 安全配置
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";
}
```

### 第八步：SSL证书配置

#### 8.1 申请免费证书

在宝塔面板 → 网站 → 你的站点 → SSL → Let's Encrypt：
- 勾选域名
- 点击申请

#### 8.2 强制HTTPS

在SSL设置中开启：
- 强制HTTPS
- HSTS

### 第九步：防火墙配置

在宝塔面板 → 安全 → 防火墙中开放端口：
- **80**: HTTP
- **443**: HTTPS
- **3000**: API服务（仅内网访问）

### 第十步：监控和日志

#### 10.1 设置监控

```bash
# 查看PM2状态
pm2 status

# 查看日志
pm2 logs dashuju-api

# 重启服务
pm2 restart dashuju-api
```

#### 10.2 日志轮转

安装PM2日志轮转：

```bash
pm2 install pm2-logrotate
pm2 set pm2-logrotate:max_size 10M
pm2 set pm2-logrotate:retain 30
```

## 🔧 维护操作

### 更新部署

```bash
# 1. 备份数据库
mysqldump -u dashuju_user -p dashuju > backup_$(date +%Y%m%d_%H%M%S).sql

# 2. 停止服务
pm2 stop dashuju-api

# 3. 更新代码
# 上传新的代码文件

# 4. 更新后端
cd /www/wwwroot/dashuju/backend
npm install --production
npm run build

# 5. 更新前端
cd /www/wwwroot/dashuju/frontend
npm install
npm run build

# 6. 重启服务
pm2 start dashuju-api
```

### 数据库备份

```bash
# 创建备份脚本
vim /www/backup/backup_db.sh

#!/bin/bash
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/www/backup/database"
mkdir -p $BACKUP_DIR

mysqldump -u dashuju_user -p你的密码 dashuju > $BACKUP_DIR/dashuju_$DATE.sql

# 删除7天前的备份
find $BACKUP_DIR -name "dashuju_*.sql" -mtime +7 -delete

# 设置定时任务
crontab -e
# 每天凌晨2点备份
0 2 * * * /www/backup/backup_db.sh
```

## ⚠️ 注意事项

1. **安全性**：
   - 定期更新系统和软件
   - 使用强密码
   - 定期备份数据
   - 监控异常访问

2. **性能优化**：
   - 启用Gzip压缩
   - 配置CDN加速
   - 数据库索引优化
   - 定期清理日志

3. **监控告警**：
   - 设置服务监控
   - 配置邮件告警
   - 监控磁盘空间
   - 监控内存使用

## 🆘 故障排除

### 常见问题

1. **API无法访问**：
   - 检查PM2服务状态
   - 检查端口是否开放
   - 查看错误日志

2. **前端页面空白**：
   - 检查构建是否成功
   - 检查Nginx配置
   - 查看浏览器控制台错误

3. **数据库连接失败**：
   - 检查数据库服务状态
   - 验证连接信息
   - 检查防火墙设置

### 日志查看

```bash
# 查看PM2日志
pm2 logs dashuju-api

# 查看Nginx日志
tail -f /www/wwwlogs/你的域名.com.log

# 查看MySQL日志
tail -f /www/server/mysql/mysql-error.log
```

## 📞 技术支持

如遇到部署问题，请检查：
1. 服务器环境是否满足要求
2. 配置文件是否正确
3. 端口是否正常开放
4. 日志文件中的错误信息

---

**部署完成后，访问你的域名即可使用大数据查询系统！**