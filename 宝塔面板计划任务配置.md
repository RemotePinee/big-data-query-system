# 宝塔面板计划任务配置说明

## 概述

本文档说明如何在宝塔面板中配置计划任务来替代原有的服务器内置定时任务，实现查询结果的自动清理和监控。

## 前置条件

1. 确保后端服务已正常运行
2. 确保 Node.js 环境可用
3. 确保数据库连接正常

## 配置步骤

### 1. 登录宝塔面板

访问宝塔面板管理界面，使用管理员账户登录。

### 2. 进入计划任务

在左侧菜单中找到 **"计划任务"** 并点击进入。

### 3. 添加清理任务

#### 任务1：每7天清理过期查询结果

- **任务名称**: `清理过期查询结果`
- **任务类型**: `Shell脚本`
- **执行周期**: `每周`
- **执行时间**: `周日 02:00` (每周日凌晨2点)
- **脚本内容：**
```bash
#!/bin/bash
PATH=/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin:/usr/local/sbin:~/bin
. ~/.bashrc
export PATH

cd /www/wwwroot/dashuju/backend
node cleanup-task.js cleanup

echo "----------------------------------------------------------------------------"
endDate=`date +"%Y-%m-%d %H:%M:%S"`
echo "★[$endDate] 清理任务执行完成"
echo "----------------------------------------------------------------------------"
```

#### 任务2：每小时检查过期统计

- **任务名称**: `检查即将过期的查询结果`
- **任务类型**: `Shell脚本`
- **执行周期**: `每小时`
- **执行时间**: `00分`
- **脚本内容**:
```bash
#!/bin/bash
PATH=/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin:/usr/local/sbin:~/bin
. ~/.bashrc
export PATH

cd /www/wwwroot/dashuju/backend
node cleanup-task.js stats

echo "----------------------------------------------------------------------------"
endDate=`date +"%Y-%m-%d %H:%M:%S"`
echo "★[$endDate] 统计检查完成"
echo "----------------------------------------------------------------------------"
```

### 4. 路径配置说明

**重要：** 请根据你的实际服务器情况修改脚本中的路径：

1. **项目路径：** `/www/wwwroot/dashuju/backend` - 修改为你的实际项目backend目录路径
2. **脚本文件：** 确保 `cleanup-task.js` 文件已上传到项目backend目录

## 使用方法

1. 在宝塔面板 → 计划任务 → 添加任务
2. 任务类型选择：**Shell脚本**
3. 复制上面的脚本内容，粘贴到脚本内容框
4. 修改脚本中的 `/www/wwwroot/dashuju/backend` 为你的实际项目backend目录路径
5. 保存并启用任务

## 日志查看

宝塔面板会自动记录任务执行日志，你可以在：
- 计划任务 → 对应任务 → 日志 查看执行情况

## 注意事项

1. **上传文件：** 确保 `cleanup-task.js` 文件已上传到服务器项目backend目录
2. **路径正确：** 脚本中的项目路径必须正确
3. **权限问题：** 确保宝塔面板有权限访问项目目录

## 故障排除

如果任务执行失败，检查以下几点：

1. **文件不存在：** 确保 `cleanup-task.js` 已上传到正确位置
2. **路径错误：** 检查脚本中的项目路径是否正确
3. **Node.js问题：** 确保服务器已安装Node.js

完成配置后，你的清理任务就会按设定时间自动执行了！